<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EcoMunity - Scambio Etico e Comunitario</title>
<script type="module">
  // --- 1. IMPORTAZIONI COMPLETE FIREBASE ---
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
  // Importazioni per l'Autenticazione (Login Google)
  import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-auth.js";
  // Importazioni per il Database (Firestore - Interazioni/Pubblicazione)
  
  // AGGIUNTE: doc, deleteDoc, updateDoc, getDoc, setDoc, orderBy
import { getFirestore, collection, addDoc, query, where, onSnapshot, doc, deleteDoc, updateDoc, getDoc, setDoc, orderBy } 
from "https://www.gstatic.com/firebasejs/12.4.0/firebase-firestore.js";

  // Your web app's Firebase configuration (I tuoi dati restano invariati)
  const firebaseConfig = {
    apiKey: "AIzaSyCTwU75eJLGpuz5jw_gkhHdgYrHUkN__AY",
    authDomain: "ecomunity-app.firebaseapp.com",
    projectId: "ecomunity-app",
    storageBucket: "ecomunity-app.firebasestorage.app",
    messagingSenderId: "788175207861",
    appId: "1:788175207861:web:e3f159da01c096e0d3edfc"
  };

  // Inizializza Firebase
  const app = initializeApp(firebaseConfig);
  
  // --- 2. INIZIALIZZAZIONE SERVIZI FIREBASE ---
  const auth = getAuth(app); // Servizio di Autenticazione
  const db = getFirestore(app); // Servizio Database Firestore
  const googleProvider = new GoogleAuthProvider(); // Provider per Google Login
  
  // Variabile per tenere traccia del tipo di offerta (bene o servizio)
  let currentOfferType = 'bene';

  // --- FUNZIONI DI GESTIONE UI ---
  
  // Funzione per cambiare schermata
  function switchScreen(screenId) {
    document.querySelectorAll('.screen').forEach(screen => {
      screen.classList.remove('active');
    });
    const screenToShow = document.getElementById(screenId);
    if (screenToShow) {
        screenToShow.classList.add('active');
        // Nasconde sempre la schermata di login quando si entra nell'app
        document.getElementById('login-screen').style.display = 'none'; 
    }
  }

  // Funzione per gestire i click sulla Tab Bar
  window.navigate = function(screenId, element) {
    switchScreen(screenId);
    // Aggiorna lo stato "attivo" della tab bar
    document.querySelectorAll('.tab-item').forEach(item => {
        item.classList.remove('active');
    });
    element.classList.add('active');
  }

  // Funzione per il toggle del tipo di offerta nella schermata di Pubblicazione
  window.toggleOfferType = function(type) {
    currentOfferType = type;
    document.getElementById('type-bene').classList.remove('bg-[#22c55e]', 'text-white');
    document.getElementById('type-servizio').classList.remove('bg-[#22c55e]', 'text-white');
    document.getElementById('type-bene').classList.add('text-gray-700', 'hover:bg-gray-200');
    document.getElementById('type-servizio').classList.add('text-gray-700', 'hover:bg-gray-200');

    if (type === 'bene') {
        document.getElementById('type-bene').classList.add('bg-[#22c55e]', 'text-white');
    } else {
        document.getElementById('type-servizio').classList.add('bg-[#22c55e]', 'text-white');
    }
  }

  // NUOVA FUNZIONE: per cambiare tra scheda Beni e Servizi sulla Home
  window.switchHomeTab = function(type, element) {
    // Nasconde tutti i contenuti della Home Tab
    document.querySelectorAll('.home-tab-content').forEach(content => {
      content.classList.add('hidden');
      content.classList.remove('active');
    });
    
    // Rimuove la classe attiva da tutti i bottoni della barra
    document.getElementById('tab-btn-beni').classList.remove('bg-[#22c55e]', 'text-white');
    document.getElementById('tab-btn-servizi').classList.remove('bg-[#22c55e]', 'text-white');
    document.getElementById('tab-btn-beni').classList.add('text-gray-700', 'hover:bg-gray-200');
    document.getElementById('tab-btn-servizi').classList.add('text-gray-700', 'hover:bg-gray-200');

    // Mostra il contenuto corretto
    document.getElementById('home-' + type).classList.remove('hidden');
    document.getElementById('home-' + type).classList.add('active');

    // Applica lo stile attivo al bottone
    element.classList.remove('text-gray-700', 'hover:bg-gray-200');
    element.classList.add('bg-[#22c55e]', 'text-white');
  }


  // --- 3. FUNZIONE DI AUTENTICAZIONE GOOGLE ---
  // Funzione chiamata dal pulsante di login (aggiunta a window per l'onclick)
  window.handleAuth = async function() {
    try {
        const result = await signInWithPopup(auth, googleProvider);
        // L'utente si è loggato con successo. onAuthStateChanged gestirà l'UI.
        console.log("Accesso Google completato per:", result.user.displayName);
    } catch (error) {
        // Gestione degli errori (es. l'utente ha chiuso il popup)
        console.error("Errore di Autenticazione:", error.code, error.message);
        if (error.code !== 'auth/popup-closed-by-user') {
            alert("Errore di accesso. Riprova: " + error.message);
        }
    }
  };

  // Funzione di Logout (da collegare a un pulsante nella schermata Profilo)
  window.handleLogout = async function() {
      await signOut(auth);
      console.log("Utente disconnesso.");
      // onAuthStateChanged gestirà il reindirizzamento alla schermata di Login
  }


  // --- 4. GESTIONE STATO UTENTE (ON LOAD) ---
  // Controlla lo stato di autenticazione all'avvio dell'app
  onAuthStateChanged(auth, (user) => {
    // 1. Nasconde la schermata di caricamento
    document.getElementById('loading-screen').style.display = 'none';
    document.getElementById('app-container').classList.remove('hidden');
    
    if (user) {
        // Utente loggato (Registrato o Ri-loggato)
        console.log("Utente attivo:", user.uid, user.displayName);

        // **MODIFICHE PER GARANTIRE LA VISIBILITÀ SU TUTTI I BROWSER**
        document.getElementById('app-header').style.display = 'block'; 
        document.getElementById('tab-bar').style.display = 'flex'; 
        
        // Aggiorna l'UI del profilo se necessario (es. nome utente)
        document.getElementById('profile-name').textContent = user.displayName || "Utente EcoMunity";
        
        // Passa alla schermata Home e attiva l'icona
        switchScreen('home-screen');
        document.getElementById('nav-home').classList.add('active');

        // Carica le offerte dal database
        loadOffers(); 
        loadChatList(); // Serve per inizializzare il listener dei messaggi
    } else {
        // Utente NON loggato
        console.log("Nessun utente loggato. Mostra schermata di Login.");
        // Mostra la schermata di Login (deve essere in display:flex per il centraggio)
        document.getElementById('login-screen').style.display = 'flex';
        // Nasconde l'header e la tab bar quando non loggato
        document.getElementById('app-header').style.display = 'none';
        document.getElementById('tab-bar').style.display = 'none';
    }
  });
  
// Variabile per tenere traccia della chat correntemente aperta
let currentChatId = null;

// Funzione per aprire una chat specifica
window.openChat = function(chatId, offerTitle) {
    currentChatId = chatId;
    document.getElementById('current-chat-id').value = chatId;
    document.getElementById('current-chat-title').textContent = offerTitle;
    
    // Passa alla schermata di chat
    document.getElementById('chat-screen').style.display = 'flex';
    
    // Rimuovi l'header e la tab bar per la chat
    document.getElementById('app-header').style.display = 'none';
    document.getElementById('tab-bar').style.display = 'none';

    // Carica i messaggi
    loadChatMessages(chatId);
}

// Funzione per inviare un messaggio
window.sendMessage = async function(event) {
    event.preventDefault();
    const messageInput = document.getElementById('message-input');
    const messageText = messageInput.value.trim();
    const chatId = document.getElementById('current-chat-id').value;
    const currentUser = auth.currentUser;

    if (!messageText || !chatId || !currentUser) {
        return;
    }

    try {
        // 1. Aggiungi il messaggio alla sottocollezione 'messages'
        await addDoc(collection(db, "chats", chatId, "messages"), {
            senderId: currentUser.uid,
            senderName: currentUser.displayName,
            text: messageText,
            timestamp: new Date()
        });

        // 2. Aggiorna l'ultimo messaggio nel documento principale della chat (ottimizzazione)
        const chatRef = doc(db, "chats", chatId);
        await updateDoc(chatRef, {
            lastMessage: messageText.substring(0, 50) + (messageText.length > 50 ? '...' : ''),
            lastMessageTimestamp: new Date()
        });

        // Resetta il campo di input
        messageInput.value = '';
        
    } catch (e) {
        console.error("Errore nell'invio del messaggio: ", e);
        alert("Impossibile inviare il messaggio.");
    }
}

// Funzione per caricare e visualizzare i messaggi in tempo reale
function loadChatMessages(chatId) {
    if (!chatId) return;

    const currentUser = auth.currentUser;
    const messagesContainer = document.getElementById('messages-container');
    
    // Inizia l'ascolto in tempo reale sulla sottocollezione 'messages', ordinando per timestamp
    const q = query(collection(db, "chats", chatId, "messages"), orderBy("timestamp", "asc"));

    onSnapshot(q, (querySnapshot) => {
        let messagesHtml = '';
        
        querySnapshot.forEach((doc) => {
            const msg = doc.data();
            const isMe = msg.senderId === currentUser.uid;
            
            // Stile del messaggio a seconda del mittente
            const messageClass = isMe 
                ? 'self-end bg-[#dcf8c6] text-gray-900 rounded-bl-xl rounded-tl-xl rounded-tr-xl' 
                : 'self-start bg-white text-gray-800 rounded-br-xl rounded-tr-xl rounded-tl-xl border border-gray-100';
            
            const timeString = msg.timestamp && msg.timestamp.toDate ? msg.timestamp.toDate().toLocaleTimeString('it-IT', { hour: '2-digit', minute: '2-digit' }) : 'Ora Sconosciuta';

            messagesHtml += `
                <div class="max-w-[75%] p-3 shadow-sm ${messageClass}">
                    <p class="text-sm">${msg.text}</p>
                    <span class="text-xs text-right block ${isMe ? 'text-gray-600' : 'text-gray-500'} mt-1">${timeString}</span>
                </div>
            `;
        });

        messagesContainer.innerHTML = messagesHtml;
        // Scorrimento automatico in basso (necessario per le chat)
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
    });
}

// Funzione di navigazione per tornare dalla chat
window.navigateFromChat = function(screenId, element) {
    document.getElementById('chat-screen').style.display = 'none';
    
    // Riporta l'header e la tab bar
    document.getElementById('app-header').style.display = 'block'; 
    document.getElementById('tab-bar').style.display = 'flex'; 

    // Esegui la navigazione standard
    switchScreen(screenId);
    document.querySelectorAll('.tab-item').forEach(item => {
        item.classList.remove('active');
    });
    element.classList.add('active');
}

  // --- 5. INTERAZIONE DATABASE (ESEMPIO DI PUBBLICAZIONE) ---
  // Funzione per salvare una nuova offerta su Firestore
  window.publishOffer = async function(event) {
    event.preventDefault(); // Impedisce il ricaricamento della pagina
    
    // Recupera i dati del form
    const title = document.getElementById('title').value;
    const description = document.getElementById('description').value;
    // AGGIUNTA: Recupera il valore CP e assicurati che sia un numero intero
    const cpValue = parseInt(document.getElementById('cp-value').value, 10);
    
    // Controllo base sul valore CP
    if (isNaN(cpValue) || cpValue <= 0) {
        alert("Inserisci un valore Karma (CP) valido e positivo.");
        return;
    }
    
    // Ottieni l'utente corrente per associare l'offerta
    const user = auth.currentUser;
    if (!user) {
        alert("Devi essere loggato per pubblicare un'offerta.");
        return;
    }

    try {
        const docRef = await addDoc(collection(db, "offerte"), {
            title: title,
            description: description,
            type: currentOfferType, // 'bene' o 'servizio'
            cpValue: cpValue, // AGGIUNTA: Salva il valore CP
            ownerId: user.uid,
            ownerName: user.displayName,
            timestamp: new Date(),
            status: 'available'
        });
        
        console.log("Documento scritto con ID: ", docRef.id);
        alert("Offerta pubblicata con successo!");
        
        // Reset del form e navigazione alla home
        document.getElementById('publish-form').reset();
        window.navigate('home-screen', document.getElementById('nav-home'));

    } catch (e) {
        console.error("Errore durante l'aggiunta del documento: ", e);
        alert("Errore durante la pubblicazione. Controlla la console.");
    }
  }

   // ************************************************************
  // ** NUOVE FUNZIONI DI GESTIONE CHAT, STATO E ASSEGNAZIONE CP **
  // ************************************************************

  // NUOVA FUNZIONE: Richiede il feedback, gestisce l'assegnazione di CP e imposta lo stato a 'completed'
  window.requestFeedback = async function(docId, cpValue) {
      const user = auth.currentUser;
      if (!user) {
          alert("Errore di autenticazione.");
          return;
      }
      
      const offerRef = doc(db, "offerte", docId);
      const offerSnap = await getDoc(offerRef); // Ottiene lo stato attuale
      if (!offerSnap.exists() || offerSnap.data().status !== 'reserved' || offerSnap.data().ownerId !== user.uid) {
           alert("Impossibile completare. L'offerta non è riservata o non sei il proprietario.");
           return;
      }

      // Semplice richiesta di feedback tramite prompt per simulare le 3 opzioni (SIMULAZIONE CP/Karma)
      const feedback = prompt(
          "L'oggetto è stato ritirato con successo? Scegli un'opzione:\n" +
          "1: Andato a Buon Fine (Assegna 100% CP)\n" +
          "2: Meritevole (Extra CP, +120%)\n" +
          "3: Qualcosa Non ha Funzionato (0 CP, Bassa affidabilità)"
      );

      let finalCP = 0;
      let feedbackType = '';
      
      switch (feedback) {
          case '1':
              finalCP = cpValue; // 100% del valore (Es. 50 CP)
              feedbackType = 'success';
              break;
          case '2':
              finalCP = Math.round(cpValue * 1.2); // 120% del valore (Es. 60 CP)
              feedbackType = 'merit';
              break;
          case '3':
              finalCP = 0; // Nessun CP
              feedbackType = 'fail';
              break;
          default:
              alert("Selezione non valida. Annullato.");
              return;
      }
      
      if (feedbackType === 'fail' && !confirm("Sei sicuro di voler dare un feedback negativo? L'acquirente non riceverà CP.")) {
           return;
      }

      try {
          // 1. Aggiornamento Stato Offerta a 'completed'
          await updateDoc(offerRef, {
              status: 'completed', 
              feedback: feedbackType, 
              cp_awarded: finalCP,
              completionDate: new Date()
          });

          // 2. Notifica e ricarica
          alert(`Scambio completato! L'acquirente riceverà ${finalCP} CP.`);
          loadOffers(); 
          
      } catch (e) {
          console.error("Errore durante il completamento dello scambio: ", e);
          alert("Errore nel completare lo scambio. Controlla la console.");
      }
  }
  
// NUOVA FUNZIONE: Avvia la chat, imposta l'offerta a 'reserved' e reindirizza
  // Versione corretta che controlla l'esistenza della chat e aggiorna lo stato offerta.
  window.initiateChat = async function(offerId, ownerId, offerTitle) {
      const user = auth.currentUser;
      if (!user) {
          alert("Devi essere loggato per contattare il venditore.");
          return;
      }
      if (user.uid === ownerId) {
          alert("Non puoi avviare una chat con te stesso.");
          return;
      }

      const offerRef = doc(db, "offerte", offerId);
      
      try {
          // 1. Controllo Stato Offerta
          const offerSnap = await getDoc(offerRef);
          if (offerSnap.exists() && offerSnap.data().status !== 'available') {
               alert("Questa offerta non è più disponibile o è già riservata.");
               loadOffers(); // Aggiorna la lista
               return;
          }

          // 2. Aggiorna lo stato dell'offerta a 'reserved'
          await updateDoc(offerRef, {
              status: 'reserved',
              reservedBy: user.uid, 
              reservedByName: user.displayName
          });
          
          // 3. Logica Chat: Costruisci ID univoco e cerca chat esistente
          const participants = [ownerId, user.uid].sort();
          const chatId = participants.join('_'); 
          const chatRef = doc(db, "chats", chatId);
          const chatDoc = await getDoc(chatRef);

          if (!chatDoc.exists()) {
              // Crea la chat solo se non esiste
              await setDoc(chatRef, { 
                  offerId: offerId,
                  offerTitle: offerTitle,
                  participants: participants, 
                  sellerId: ownerId,
                  buyerId: user.uid,
                  lastMessage: `Chat avviata per ${offerTitle}.`,
                  lastMessageTimestamp: new Date()
              });
          }
          
          alert(`Hai riservato l'offerta e avviato la chat!`);
          
          // 4. Naviga alla schermata della chat
          window.navigate('chat-list-screen', document.getElementById('nav-chat'));
          window.openChat(chatId, offerTitle); 
          loadOffers(); // Aggiorna la lista

      } catch (e) {
          console.error("Errore nell'avvio della chat:", e);
          alert("Errore nell'avvio della chat. Riprova. Potrebbe essere un problema di regole di sicurezza o un problema di connessione.");
      }
  }
  
  // NUOVA FUNZIONE: Carica la lista delle chat
  function loadChatList() {
      const currentUser = auth.currentUser;
      if (!currentUser) return;
      
      const q = query(
          collection(db, "chats"),
          where("participants", "array-contains", currentUser.uid)
      );
      
      onSnapshot(q, (querySnapshot) => {
          let chatsHtml = '';
          let count = 0;
          
          querySnapshot.forEach((doc) => {
              const chat = doc.data();
              const chatId = doc.id;
              
              count++;
              const isSeller = chat.sellerId === currentUser.uid;
              
              chatsHtml += `
                  <div onclick="openChat('${chatId}', \`${chat.offerTitle}\`)" class="bg-white p-4 rounded-xl shadow-sm border border-gray-100 hover:bg-gray-50 transition cursor-pointer">
                      <p class="font-bold text-gray-800">${chat.offerTitle} (${isSeller ? 'Offerta' : 'Acquisto'})</p>
                      <p class="text-sm text-gray-500 truncate">Ultimo messaggio: ${chat.lastMessage || 'Nessun messaggio'}</p>
                  </div>
              `;
          });

          document.getElementById('chat-list-container').innerHTML = chatsHtml;
          document.getElementById('empty-chats').style.display = count === 0 ? 'block' : 'none';
      });
  }

        // --- 6. INTERAZIONE DATABASE (LETTURA E POPOLAZIONE OFFERTE) ---
  // Funzione per leggere e popolare le offerte, ora con gestione stati (available, reserved, completed)
  function loadOffers() {
      const currentUser = auth.currentUser;
      const currentUserId = currentUser ? currentUser.uid : null;
      
      const q = query(collection(db, "offerte"), orderBy("timestamp", "desc"));
      
      onSnapshot(q, (querySnapshot) => {
          let beniHtml = '';
          let serviziHtml = '';
          
          querySnapshot.forEach((document) => {
              const offer = document.data();
              const docId = document.id; 
              const isOwner = currentUserId && offer.ownerId === currentUserId; 
              
              const status = offer.status || 'available'; 
              const isAvailable = status === 'available';
              const isReserved = status === 'reserved';
              const isCompleted = status === 'completed';
              const isReservedByMe = isReserved && offer.reservedBy === currentUserId;
              
              const cpValue = offer.cpValue || 0; 

              // ********** PULSANTI PROPRIETARIO **********
              let ownerButtons = '';
              if (isOwner && !isCompleted) {
                  ownerButtons = `
                      <div class="flex space-x-2 mt-2">
                          <button onclick="deleteOffer('${docId}')" 
                              class="px-2 py-1 text-xs bg-red-500 text-white font-medium rounded-full hover:bg-red-600 transition">
                              Elimina
                          </button>
                      </div>
                  `;
              }
              
              // ********** PULSANTE AZIONE PRINCIPALE **********
              let actionButton = '';
              let statusBadge = '';

              if (isOwner) {
                  if (isReserved) {
                      // Proprietario: Pulsante per assegnare CP
                      const reservedByName = offer.reservedByName || 'Acquirente';
                      actionButton = `
                          <div class="flex flex-col items-center">
                              <p class="text-sm text-blue-600 font-medium mb-1">Riservata a: ${reservedByName.split(' ')[0]}</p>
                              <button onclick="requestFeedback('${docId}', ${cpValue})" 
                                  class="px-3 py-1 bg-blue-500 text-white text-sm font-medium rounded-full hover:bg-blue-600 transition">
                                  Conferma Scambio (Assegna CP)
                              </button>
                          </div>
                      `;
                      statusBadge = `<span class="text-xs text-blue-500 font-bold ml-2">RISERVATA</span>`;

                  } else if (isCompleted) {
                       actionButton = `<span class="px-3 py-1 bg-gray-400 text-white text-sm font-medium rounded-full">SCAMBIATA</span>`;
                       statusBadge = `<span class="text-xs text-gray-500 font-bold ml-2">COMPLETATA</span>`;
                  }

              } else { // Non è il proprietario
                  if (isAvailable) {
                      // Acquirente: Pulsante Contatta/Riserva
                      actionButton = `
                          <button onclick="initiateChat('${docId}', '${offer.ownerId}', \`${offer.title}\`)" 
                              class="px-3 py-1 bg-green-500 text-white text-sm font-medium rounded-full hover:bg-green-600 transition">
                              Contatta (Costo: ${cpValue} CP)
                          </button>
                      `;
                  } else if (isReserved && !isReservedByMe) {
                      // Acquirente: Offerta riservata da altro utente
                      actionButton = `<span class="px-3 py-1 bg-gray-400 text-white text-sm font-medium rounded-full">RISERVATA</span>`;
                      statusBadge = `<span class="text-xs text-blue-500 font-bold ml-2">RISERVATA</span>`;
                  } else if (isReserved && isReservedByMe) {
                      // Acquirente: Offerta riservata da me
                      actionButton = `<span class="px-3 py-1 bg-yellow-500 text-white text-sm font-medium rounded-full">TUA RISERVA</span>`;
                      statusBadge = `<span class="text-xs text-blue-500 font-bold ml-2">RISERVATA (Tu)</span>`;
                  } else if (isCompleted) {
                      // Acquirente: Offerta completata
                      actionButton = `<span class="px-3 py-1 bg-gray-400 text-white text-sm font-medium rounded-full">SCAMBIATA</span>`;
                      statusBadge = `<span class="text-xs text-gray-500 font-bold ml-2">COMPLETATA</span>`;
                  }
              }


              // Costruisci il blocco HTML per l'offerta
              const offerHtml = `
                <div class="bg-white p-4 rounded-lg shadow-sm flex justify-between items-start border border-gray-200">
                    <div>
                        <p class="font-semibold text-lg">${offer.title} ${statusBadge}</p>
                        <p class="text-sm text-gray-500">${offer.description}</p>
                        <p class="text-xs text-gray-400 mt-1">Offerto da: ${offer.ownerName}</p>
                        <p class="text-sm font-bold text-yellow-600 mt-2">Valore: ${cpValue} CP</p>
                        ${ownerButtons}
                    </div>
                    ${actionButton}
                </div>
              `;

              if (offer.type === 'bene') {
                  beniHtml += offerHtml;
              } else if (offer.type === 'servizio') {
                  serviziHtml += offerHtml;
              }
          });

          // Aggiorna l'HTML della Home Screen
          document.getElementById('item-list-bene').innerHTML = beniHtml;
          document.getElementById('item-list-servizio').innerHTML = serviziHtml;
          document.getElementById('empty-bene').style.display = beniHtml ? 'none' : 'block';
          document.getElementById('empty-servizio').style.display = serviziHtml ? 'none' : 'block';
      });
  }

  // --- 7. INIZIALIZZAZIONE ---
  // Listener di autenticazione: gestisce login/logout e carica i dati iniziali
  onAuthStateChanged(auth, (user) => {
      if (user) {
          window.navigate('home-screen', document.getElementById('nav-home'));
          loadOffers(); 
          loadChatList(); 
          loadProfileData(user.uid); 
      } else {
          window.navigate('login-screen', document.getElementById('nav-home'));
      }
  });

</script> 
</body>
</html>
