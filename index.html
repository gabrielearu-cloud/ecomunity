<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EcoMunity - Scambio Etico e Comunitario</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Nasconde le schermate non attive */
        .screen:not(.active) {
            display: none;
        }
    </style>
</head>
<body class="bg-gray-50">

<script type="module">
  // --- 1. IMPORTAZIONI COMPLETE FIREBASE ---
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
  // Importazioni per l'Autenticazione (Login Google)
  import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-auth.js";
  // Importazioni per il Database (Firestore - Interazioni/Pubblicazione)
  
  // AGGIUNTE: doc, deleteDoc, updateDoc, getDoc, setDoc, orderBy, where
import { getFirestore, collection, addDoc, query, where, onSnapshot, doc, deleteDoc, updateDoc, getDoc, setDoc, orderBy } 
from "https://www.gstatic.com/firebasejs/12.4.0/firebase-firestore.js";


  // Your web app's Firebase configuration (I tuoi dati restano invariati)
  const firebaseConfig = {
    apiKey: "AIzaSyCTwU75eJLGpuz5jw_gkhHdgYrHUkN__AY",
    authDomain: "ecomunity-app.firebaseapp.com",
    projectId: "ecomunity-app",
    storageBucket: "ecomunity-app.appspot.com",
    messagingSenderId: "331885404505",
    appId: "1:331885404505:web:8e16cc07817b11ce13d07e"
  };

  // Inizializza Firebase
  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app); // Inizializza Firestore

  // --- 2. GESTIONE NAVIGAZIONE SCHERMATE (UI) ---
  window.navigate = function(targetScreenId, targetTab) {
      document.querySelectorAll('.screen').forEach(screen => {
          screen.classList.remove('active');
      });
      document.getElementById(targetScreenId).classList.add('active');
      
      document.querySelectorAll('.tab-item').forEach(tab => {
          tab.classList.remove('text-blue-600', 'font-bold');
      });
      if (targetTab) {
          targetTab.classList.add('text-blue-600', 'font-bold');
      }
      
      // Funzione specifica per l'Home Screen: ricarica le offerte e la lista chat ad ogni visita.
      if (targetScreenId === 'home-screen' && auth.currentUser) {
          loadOffers(); 
      }
      if (targetScreenId === 'chat-list-screen' && auth.currentUser) {
          loadChatList();
      }
  }

  // NUOVA FUNZIONE: GESTIONE TAB OFFERTE (Beni/Servizi) - CORREZIONE INTERFACCIA
  window.toggleOfferTabs = function(type) {
      // 1. Gestione Contenuto (nasconde/mostra le liste)
      const beniContent = document.getElementById('beni-list');
      const serviziContent = document.getElementById('servizi-list');

      if (type === 'beni') {
          beniContent.classList.remove('hidden');
          serviziContent.classList.add('hidden');
      } else {
          beniContent.classList.add('hidden');
          serviziContent.classList.remove('hidden');
      }

      // 2. Gestione Stile Pulsanti (sottolineatura e colore)
      const tabBeni = document.getElementById('tab-beni');
      const tabServizi = document.getElementById('tab-servizi');
      
      // Resetta gli stili
      tabBeni.classList.remove('border-green-500', 'text-green-600');
      tabServizi.classList.remove('border-green-500', 'text-green-600');
      tabBeni.classList.add('border-gray-200', 'text-gray-500', 'hover:text-green-600'); 
      tabServizi.classList.add('border-gray-200', 'text-gray-500', 'hover:text-green-600'); 
      
      // Applica lo stato attivo
      if (type === 'beni') {
          tabBeni.classList.add('border-green-500', 'text-green-600');
          tabBeni.classList.remove('border-gray-200', 'text-gray-500');
      } else {
          tabServizi.classList.add('border-green-500', 'text-green-600');
          tabServizi.classList.remove('border-gray-200', 'text-gray-500');
      }
  }


  // --- 3. GESTIONE MODAL (PUBBLICA) ---
  window.openModal = function(modalId) {
      const modal = document.getElementById(modalId);
      if (modal) {
          modal.classList.remove('hidden');
      }
  }

  window.closeModal = function(modalId) {
      const modal = document.getElementById(modalId);
      if (modal) {
          modal.classList.add('hidden');
      }
  }


  // --- 4. FUNZIONI DI AUTENTICAZIONE ---

  // Login con Google
  window.signInWithGoogle = async function() {
      const provider = new GoogleAuthProvider();
      try {
          await signInWithPopup(auth, provider);
          // La funzione onAuthStateChanged gestisce la navigazione dopo il login
      } catch (error) {
          console.error("Errore di accesso:", error);
          alert("Accesso fallito.");
      }
  }

  // Logout
  window.signOutUser = async function() {
      try {
          await signOut(auth);
          alert("Sei stato disconnesso.");
          // La funzione onAuthStateChanged gestisce la navigazione dopo il logout
      } catch (error) {
          console.error("Errore di logout:", error);
      }
  }
  
  // --- 5. INTERAZIONE DATABASE (PUBBLICAZIONE) ---
  // Funzione per pubblicare una nuova offerta
  window.publishOffer = async function() {
    const user = auth.currentUser;
    if (!user) {
        alert("Devi essere loggato per pubblicare un'offerta.");
        return;
    }

    const title = document.getElementById('offer-title').value.trim();
    const description = document.getElementById('offer-description').value.trim();
    const type = document.querySelector('input[name="offer-type"]:checked')?.value;
    const cpValue = parseInt(document.getElementById('offer-cp-value').value);

    if (!title || !description || !type || isNaN(cpValue) || cpValue <= 0) {
        alert("Per favore, compila tutti i campi correttamente.");
        return;
    }

    try {
        await addDoc(collection(db, "offerte"), {
            title: title,
            description: description,
            type: type,
            ownerId: user.uid,
            ownerName: user.displayName, 
            timestamp: new Date(),
            status: 'available', // Nuovo campo: stato dell'offerta
            cpValue: cpValue // Nuovo campo: valore CP
        });

        alert("Offerta pubblicata con successo!");
        window.closeModal('publish-modal');
        // Pulisci il form dopo la pubblicazione
        document.getElementById('offer-title').value = '';
        document.getElementById('offer-description').value = '';
        document.getElementById('offer-cp-value').value = '5'; // Reset al valore predefinito
        document.getElementById('offer-type-bene').checked = true; // Reset al default
        
        // Naviga alla home per vedere la nuova offerta
        window.navigate('home-screen', document.getElementById('nav-home'));

    } catch (e) {
        console.error("Errore durante l'aggiunta del documento: ", e);
        alert("Errore durante la pubblicazione. Controlla la console.");
    }
  }

  // NUOVA FUNZIONE: ELIMINA OFFERTA (Implementata per l'onclick sulla home)
  window.deleteOffer = async function(docId) {
      if (confirm("Sei sicuro di voler eliminare questa offerta? L'azione è irreversibile.")) {
          try {
              // Trova il riferimento al documento e lo elimina
              await deleteDoc(doc(db, "offerte", docId));
              console.log("Documento eliminato con ID:", docId);
              alert("Offerta eliminata con successo!");
              // L'aggiornamento UI è automatico grazie a onSnapshot in loadOffers
          } catch (e) {
              console.error("Errore durante l'eliminazione del documento: ", e);
              alert("Errore durante l'eliminazione. Controlla le regole di sicurezza (write).");
          }
      }
  }

  // NUOVA FUNZIONE: Richiedi Feedback (Assegna CP e chiude l'offerta)
  window.requestFeedback = async function(offerId, cpValue) {
      const offerRef = doc(db, "offerte", offerId);
      const offerSnap = await getDoc(offerRef);

      if (!offerSnap.exists()) {
          alert("Offerta non trovata.");
          return;
      }
      
      const offerData = offerSnap.data();
      const buyerId = offerData.reservedBy;

      if (!buyerId) {
          alert("Errore: l'offerta non è riservata.");
          return;
      }

      if (confirm(`Confermi lo scambio con l'acquirente e vuoi assegnargli ${cpValue} CP?`)) {
          try {
              // 1. Aggiorna lo stato dell'offerta a 'completed'
              await updateDoc(offerRef, {
                  status: 'completed',
                  completionDate: new Date(),
                  // Lascia reservedBy come traccia
              });

              // 2. Aggiorna i CP dell'acquirente
              const buyerRef = doc(db, "users", buyerId);
              const buyerSnap = await getDoc(buyerRef);
              
              if (buyerSnap.exists()) {
                  const currentCp = buyerSnap.data().cpTotal || 0;
                  const newCp = currentCp + cpValue;
                  await updateDoc(buyerRef, { cpTotal: newCp });
              } else {
                   // Se per qualche motivo l'utente non esiste, lo crea con il nuovo saldo
                  await setDoc(buyerRef, { cpTotal: cpValue }, { merge: true });
              }
              
              alert(`Scambio completato! Sono stati assegnati ${cpValue} CP all'acquirente.`);
          } catch (e) {
              console.error("Errore nella conferma dello scambio:", e);
              alert("Errore nella conferma dello scambio. Controlla la console.");
          }
      }
  }

  // NUOVA FUNZIONE: Apri la chat (navigazione UI)
  window.openChat = function(chatId, chatTitle) {
      document.getElementById('chat-title').textContent = chatTitle;
      document.getElementById('chat-window').dataset.chatId = chatId;
      // TODO: Carica i messaggi (implementazione futura)
      
      window.navigate('chat-screen');
      // Nascondi la lista chat
      document.getElementById('chat-list-screen').classList.remove('active');
      document.getElementById('chat-screen').classList.add('active');
  }

  // NUOVA FUNZIONE: Invia un messaggio nella chat (Mockup)
  window.sendMessage = async function() {
      const chatWindow = document.getElementById('chat-window');
      const chatId = chatWindow.dataset.chatId;
      const messageInput = document.getElementById('message-input');
      const messageText = messageInput.value.trim();

      if (!messageText || !chatId) {
          return;
      }

      const user = auth.currentUser;
      if (!user) {
          alert("Devi essere loggato per inviare messaggi.");
          return;
      }

      try {
          // Mockup: Aggiunge il messaggio alla collezione 'messages'
          await addDoc(collection(db, "chats", chatId, "messages"), {
              senderId: user.uid,
              senderName: user.displayName.split(' ')[0],
              text: messageText,
              timestamp: new Date()
          });
          
          // Aggiorna l'ultimo messaggio nella lista chat
          await updateDoc(doc(db, "chats", chatId), {
              lastMessage: messageText,
              lastMessageTimestamp: new Date()
          });

          messageInput.value = '';
          // Il listener del mockup loadMessages aggiornerà la UI
          
      } catch (e) {
          console.error("Errore nell'invio del messaggio:", e);
          alert("Impossibile inviare il messaggio.");
      }
  }

  // NUOVA FUNZIONE: Carica la lista delle chat dell'utente corrente
  window.loadChatList = function() {
      const user = auth.currentUser;
      if (!user) return;

      const chatListElement = document.getElementById('chat-list-container');
      const chatListPlaceholder = document.getElementById('empty-chats');
      
      // Query per trovare le chat dove l'utente è membro
      const q = query(collection(db, "chats"), where("members", "array-contains", user.uid), orderBy("lastMessageTimestamp", "desc"));

      onSnapshot(q, (querySnapshot) => {
          let chatsHtml = '';
          let count = 0;
          querySnapshot.forEach((doc) => {
              const chat = doc.data();
              const chatId = doc.id;
              const otherMemberId = chat.members.find(memberId => memberId !== user.uid);
              const isOwner = chat.ownerId === user.uid;
              
              const titlePrefix = isOwner ? "Tua offerta: " : "Acquisto: ";
              const chatTitle = titlePrefix + chat.offerTitle;

              // Determina l'ultima attività (formattazione base)
              const lastActivity = chat.lastMessageTimestamp ? chat.lastMessageTimestamp.toDate().toLocaleTimeString('it-IT', {hour: '2-digit', minute:'2-digit'}) : '';

              chatsHtml += `
                  <div class="p-4 bg-white shadow-sm rounded-lg border border-gray-200 hover:bg-gray-100 cursor-pointer" 
                       onclick="window.openChat('${chatId}', \`${chatTitle}\`)">
                      <p class="font-semibold text-gray-700">${chatTitle}</p>
                      <div class="flex justify-between items-center text-sm text-gray-500 mt-1">
                          <p class="truncate">${chat.lastMessage}</p>
                          <span class="text-xs text-gray-400">${lastActivity}</span>
                      </div>
                  </div>
              `;
              count++;
          });
          chatListElement.innerHTML = chatsHtml;
          document.getElementById('empty-chats').style.display = count === 0 ? 'block' : 'none';
      });
  }

  // NUOVA FUNZIONE: Carica i dati del profilo e il totale CP
  function loadProfileData(userId) {
      const userRef = doc(db, "users", userId);
      
      // Ascolta in tempo reale le modifiche al documento utente (per i CP)
      onSnapshot(userRef, (docSnap) => {
          if (docSnap.exists()) {
              const userData = docSnap.data();
              // L'ID del campo per i CP deve essere 'cpTotal'
              const cpTotal = userData.cpTotal || 0;
              
              // Aggiorna l'elemento che mostra i CP nel profilo
              const cpElement = document.getElementById('profile-cp-total');
              if (cpElement) {
                  cpElement.textContent = `${cpTotal} CP`;
              }
               // Aggiorna nome e ID nel profilo
              const profileName = document.getElementById('profile-name');
              const profileUid = document.getElementById('profile-uid');
              if (profileName) {
                  profileName.textContent = auth.currentUser.displayName || "Utente Sconosciuto";
              }
              if (profileUid) {
                  profileUid.textContent = userId;
              }
          } else {
              // Se il documento utente non esiste (primo login), lo crea con 0 CP
              setDoc(userRef, { 
                  cpTotal: 0,
                  lastLogin: new Date()
              }, { merge: true });
          }
      });
  }

  // NUOVA FUNZIONE: Avvia la chat, imposta l'offerta a 'reserved' e reindirizza
  window.initiateChat = async function(offerId, ownerId, offerTitle) {
      const user = auth.currentUser;
      if (!user) {
          alert("Devi essere loggato per contattare il venditore.");
          return;
      }
      if (user.uid === ownerId) {
          alert("Non puoi avviare una chat con te stesso.");
          return;
      }

      // 1. Controlla se l'offerta è già riservata
      const offerRef = doc(db, "offerte", offerId);
      const offerSnap = await getDoc(offerRef);

      if (!offerSnap.exists() || offerSnap.data().status !== 'available') {
          alert("Questa offerta non è più disponibile o è già riservata.");
          loadOffers(); // Ricarica per aggiornare lo stato UI
          return;
      }

      // 2. Determina un ID univoco per la chat (ordinato alfabeticamente per evitare duplicati)
      const members = [user.uid, ownerId].sort();
      const chatId = members.join('_') + '_' + offerId;

      try {
          // 3. Verifica l'esistenza della chat
          const chatRef = doc(db, "chats", chatId);
          const chatSnap = await getDoc(chatRef);

          if (!chatSnap.exists()) {
              // Chat non esistente: crea un nuovo documento chat
              await setDoc(chatRef, {
                  offerId: offerId,
                  offerTitle: offerTitle,
                  members: members,
                  ownerId: ownerId, // ID del venditore
                  buyerId: user.uid, // ID dell'acquirente
                  lastMessage: 'Chat avviata.',
                  lastMessageTimestamp: new Date(),
              });
          }

          // 4. Imposta lo stato dell'offerta a 'reserved'
          await updateDoc(offerRef, {
              status: 'reserved',
              reservedBy: user.uid,
              reservedByName: user.displayName 
          });

          // 5. Apri la chat
          window.openChat(chatId, offerTitle);

      } catch (e) {
          console.error("Errore nell'avvio della chat: ", e);
          alert("Errore nell'avvio della chat.");
      }
  }


  // --- 6. INTERAZIONE DATABASE (LETTURA E POPOLAZIONE OFFERTE) ---
  // Funzione per leggere e popolare le offerte, ora con gestione stati (available, reserved, completed)
  function loadOffers() {
      const currentUser = auth.currentUser;
      const currentUserId = currentUser ? currentUser.uid : null;
      
      const q = query(collection(db, "offerte"), orderBy("timestamp", "desc"));
      
      onSnapshot(q, (querySnapshot) => {
          let beniHtml = '';
          let serviziHtml = '';
          
          querySnapshot.forEach((document) => {
              const offer = document.data();
              const docId = document.id; 
              const isOwner = currentUserId && offer.ownerId === currentUserId; 
              
              const status = offer.status || 'available'; 
              const isAvailable = status === 'available';
              const isReserved = status === 'reserved';
              const isCompleted = status === 'completed';
              const isReservedByMe = isReserved && offer.reservedBy === currentUserId;
              
              const cpValue = offer.cpValue || 0; 

              // ********** PULSANTI PROPRIETARIO **********
              let ownerButtons = '';
              if (isOwner && !isCompleted) {
                  ownerButtons = `
                      <div class="flex space-x-2 mt-2">
                          <button onclick="deleteOffer('${docId}')" 
                              class="px-2 py-1 text-xs bg-red-500 text-white font-medium rounded-full hover:bg-red-600 transition">
                              Elimina
                          </button>
                      </div>
                  `;
              }
              
              // ********** PULSANTE AZIONE PRINCIPALE **********
              let actionButton = '';
              let statusBadge = '';

              if (isOwner) {
                  if (isReserved) {
                      // Proprietario: Pulsante per assegnare CP
                      const reservedByName = offer.reservedByName || 'Acquirente';
                      actionButton = `
                          <div class="flex flex-col items-center">
                              <p class="text-sm text-blue-600 font-medium mb-1">Riservata a: ${reservedByName.split(' ')[0]}</p>
                              <button onclick="requestFeedback('${docId}', ${cpValue})" 
                                  class="px-3 py-1 bg-blue-500 text-white text-sm font-medium rounded-full hover:bg-blue-600 transition">
                                  Conferma Scambio (Assegna CP)
                              </button>
                          </div>
                      `;
                      statusBadge = `<span class="text-xs text-blue-500 font-bold ml-2">RISERVATA</span>`;

                  } else if (isCompleted) {
                       actionButton = `<span class="px-3 py-1 bg-gray-400 text-white text-sm font-medium rounded-full">SCAMBIATA</span>`;
                       statusBadge = `<span class="text-xs text-gray-500 font-bold ml-2">COMPLETATA</span>`;
                  }

              } else { // Non è il proprietario
                  if (isAvailable) {
                      // Acquirente: Pulsante Contatta/Riserva
                      actionButton = `
                          <button onclick="initiateChat('${docId}', '${offer.ownerId}', \`${offer.title}\`)" 
                              class="px-3 py-1 bg-green-500 text-white text-sm font-medium rounded-full hover:bg-green-600 transition">
                              Contatta (Costo: ${cpValue} CP)
                          </button>
                      `;
                  } else if (isReserved && !isReservedByMe) {
                      // Acquirente: Offerta riservata da altro utente
                      actionButton = `<span class="px-3 py-1 bg-gray-400 text-white text-sm font-medium rounded-full">RISERVATA</span>`;
                      statusBadge = `<span class="text-xs text-blue-500 font-bold ml-2">RISERVATA</span>`;
                  } else if (isReserved && isReservedByMe) {
                      // Acquirente: Offerta riservata da me
                      actionButton = `<span class="px-3 py-1 bg-yellow-500 text-white text-sm font-medium rounded-full">TUA RISERVA</span>`;
                      statusBadge = `<span class="text-xs text-blue-500 font-bold ml-2">RISERVATA (Tu)</span>`;
                  } else if (isCompleted) {
                      // Acquirente: Offerta completata
                      actionButton = `<span class="px-3 py-1 bg-gray-400 text-white text-sm font-medium rounded-full">SCAMBIATA</span>`;
                      statusBadge = `<span class="text-xs text-gray-500 font-bold ml-2">COMPLETATA</span>`;
                  }
              }


              // Costruisci il blocco HTML per l'offerta
              const offerHtml = `
                <div class="bg-white p-4 rounded-lg shadow-sm flex justify-between items-start border border-gray-200">
                    <div>
                        <p class="font-semibold text-lg">${offer.title} ${statusBadge}</p>
                        <p class="text-sm text-gray-500">${offer.description}</p>
                        <p class="text-xs text-gray-400 mt-1">Offerto da: ${offer.ownerName}</p>
                        <p class="text-sm font-bold text-yellow-600 mt-2">Valore: ${cpValue} CP</p>
                        ${ownerButtons}
                    </div>
                    ${actionButton}
                </div>
              `;

              if (offer.type === 'bene') {
                  beniHtml += offerHtml;
              } else if (offer.type === 'servizio') {
                  serviziHtml += offerHtml;
              }
          });

          // Aggiorna l'HTML della Home Screen
          document.getElementById('item-list-bene').innerHTML = beniHtml;
          document.getElementById('item-list-servizio').innerHTML = serviziHtml;
          document.getElementById('empty-bene').style.display = beniHtml ? 'none' : 'block';
          document.getElementById('empty-servizio').style.display = serviziHtml ? 'none' : 'block';
      });
      
      // Dopo aver caricato le offerte, assicurati che i tab siano gestiti correttamente
      // (in particolare, se i servizi sono attivi, ricarica lo stato)
      const tabServizi = document.getElementById('servizi-list');
      if (!tabServizi.classList.contains('hidden')) {
          window.toggleOfferTabs('servizi');
      } else {
           window.toggleOfferTabs('beni');
      }
  }

  // --- 7. INIZIALIZZAZIONE ---
  // Listener di autenticazione: gestisce login/logout e carica i dati iniziali
  onAuthStateChanged(auth, (user) => {
      if (user) {
          // Passa il corretto elemento di navigazione per mantenere lo stato attivo
          window.navigate('home-screen', document.getElementById('nav-home')); 
          loadOffers(); 
          loadChatList(); 
          loadProfileData(user.uid); 
      } else {
          window.navigate('login-screen', document.getElementById('nav-home'));
      }
  });

</script> 

<div id="publish-modal" class="modal fixed inset-0 bg-gray-600 bg-opacity-50 z-50 hidden">
    <div class="modal-content bg-white rounded-lg shadow-xl w-11/12 md:w-1/3 mx-auto mt-20 p-6">
        <h2 class="text-2xl font-bold mb-4 text-gray-800">Pubblica la tua Offerta</h2>
        <form onsubmit="event.preventDefault(); publishOffer()">
            <div class="mb-4">
                <label for="offer-title" class="block text-sm font-medium text-gray-700">Titolo</label>
                <input type="text" id="offer-title" placeholder="Es. Libro di testo di Inglese" required class="mt-1 block w-full p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500">
            </div>
            <div class="mb-4">
                <label for="offer-description" class="block text-sm font-medium text-gray-700">Descrizione</label>
                <textarea id="offer-description" rows="3" placeholder="Descrivi brevemente cosa offri e le condizioni..." required class="mt-1 block w-full p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500"></textarea>
            </div>
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700">Tipo di Offerta</label>
                <div class="mt-2 space-x-4">
                    <label class="inline-flex items-center">
                        <input type="radio" name="offer-type" value="bene" id="offer-type-bene" checked class="form-radio text-green-600">
                        <span class="ml-2">Bene Materiale</span>
                    </label>
                    <label class="inline-flex items-center">
                        <input type="radio" name="offer-type" value="servizio" class="form-radio text-green-600">
                        <span class="ml-2">Servizio/Aiuto</span>
                    </label>
                </div>
            </div>
            <div class="mb-6">
                <label for="offer-cp-value" class="block text-sm font-medium text-gray-700">Valore in Karma Points (CP)</label>
                <input type="number" id="offer-cp-value" value="5" min="1" required class="mt-1 block w-full p-2 border border-yellow-500 rounded-md bg-yellow-50 focus:ring-yellow-500 focus:border-yellow-500">
            </div>
            <div class="flex justify-end space-x-3">
                <button type="button" onclick="closeModal('publish-modal')" class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-200 rounded-md hover:bg-gray-300 transition">Annulla</button>
                <button type="submit" class="px-4 py-2 text-sm font-medium text-white bg-blue-600 rounded-md hover:bg-blue-700 transition">Pubblica</button>
            </div>
        </form>
    </div>
</div>

<div id="login-screen" class="screen active fixed inset-0 flex flex-col items-center justify-center bg-gray-100 z-50">
    <div class="bg-white p-8 rounded-xl shadow-2xl text-center w-80">
        <h1 class="text-3xl font-extrabold text-green-600 mb-2">EcoMunity</h1>
        <p class="text-gray-600 mb-8">Scambio Etico e Comunitario</p>
        <button onclick="signInWithGoogle()" class="w-full flex items-center justify-center bg-blue-500 hover:bg-blue-600 text-white font-medium py-3 px-4 rounded-lg shadow-md transition duration-200">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-log-in mr-2"><path d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4"/><polyline points="10 17 15 12 10 7"/><line x1="15" x2="3" y1="12" y2="12"/></svg>
            Accedi con Google
        </button>
        <p class="text-xs text-gray-400 mt-4">Solo per membri registrati.</p>
    </div>
</div>

<div id="home-screen" class="screen min-h-screen pb-20">
    <header class="bg-white shadow-sm sticky top-0 z-10">
        <div class="max-w-7xl mx-auto py-4 px-4 sm:px-6 lg:px-8 flex justify-between items-center">
            <h1 class="text-xl font-bold text-green-600">EcoMunity - Offerte</h1>
            <button onclick="signOutUser()" class="flex items-center text-sm text-white bg-red-500 px-3 py-1 rounded-full hover:bg-red-600 transition">
                 <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-log-out mr-1"><path d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4"/><polyline points="10 17 15 12 10 7"/><line x1="15" x2="3" y1="12" y2="12"/></svg>
                 Logout
            </button>
        </div>
    </header>

    <main class="max-w-7xl mx-auto py-6 sm:px-6 lg:px-8">
        
        <div class="flex justify-start space-x-4 border-b border-gray-200 mb-6 px-4 sm:px-0">
            <button id="tab-beni" onclick="window.toggleOfferTabs('beni')" 
                    class="pb-2 font-medium border-b-2 border-green-500 text-green-600">Beni Materiali</button>
            <button id="tab-servizi" onclick="window.toggleOfferTabs('servizi')" 
                    class="pb-2 font-medium text-gray-500 hover:text-green-600 transition">Servizi</button>
        </div>

        <div id="beni-list" class="space-y-4 px-4 sm:px-0">
            <div id="item-list-bene" class="space-y-4">
                </div>
             <p id="empty-bene" class="text-center text-gray-500 p-8 hidden">Non ci sono ancora beni materiali offerti. Sii il primo!</p>
        </div>

        <div id="servizi-list" class="hidden space-y-4 px-4 sm:px-0">
            <div id="item-list-servizio" class="space-y-4">
                </div>
            <p id="empty-servizio" class="text-center text-gray-500 p-8 hidden">Non ci sono ancora servizi offerti. Sii il primo!</p>
        </div>

    </main>
</div>

<div id="chat-list-screen" class="screen min-h-screen pb-20">
    <header class="bg-white shadow-sm">
        <div class="max-w-7xl mx-auto py-4 px-4 sm:px-6 lg:px-8">
            <h1 class="text-xl font-bold text-gray-800">Le mie Chat</h1>
        </div>
    </header>
    <main class="max-w-7xl mx-auto py-6 sm:px-6 lg:px-8">
        <div id="chat-list-container" class="space-y-4 px-4 sm:px-0">
            </div>
        <p id="empty-chats" class="text-center text-gray-500 p-8 hidden">Non hai ancora avviato o ricevuto chat.</p>
    </main>
</div>

<div id="chat-screen" class="screen fixed inset-0 flex flex-col bg-gray-50">
    <header class="bg-white shadow-md">
        <div class="max-w-7xl mx-auto py-4 px-4 sm:px-6 lg:px-8 flex items-center">
            <button onclick="navigate('chat-list-screen', document.getElementById('nav-chat'))" class="mr-4 text-gray-500 hover:text-gray-700">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-arrow-left"><path d="m12 19-7-7 7-7"/><path d="M19 12H5"/></svg>
            </button>
            <h1 id="chat-title" class="text-xl font-bold text-gray-800 truncate">Chat con...</h1>
        </div>
    </header>
    <main id="chat-window" data-chat-id="" class="flex-grow overflow-y-auto p-4 space-y-4">
        <p class="text-center text-gray-500">I messaggi appariranno qui...</p>
    </main>
    <footer class="bg-white border-t border-gray-200 p-4">
        <div class="max-w-7xl mx-auto flex">
            <input type="text" id="message-input" placeholder="Scrivi un messaggio..." class="flex-grow p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
            <button onclick="sendMessage()" class="ml-3 bg-blue-500 hover:bg-blue-600 text-white p-3 rounded-lg flex items-center transition">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-send"><path d="m22 2-7 19-10-6z"/><path d="M22 2 11 13"/></svg>
            </button>
        </div>
    </footer>
</div>

<div id="profile-screen" class="screen min-h-screen pb-20">
    <header class="bg-white shadow-sm">
        <div class="max-w-7xl mx-auto py-4 px-4 sm:px-6 lg:px-8">
            <h1 class="text-xl font-bold text-gray-800">Il mio Profilo</h1>
        </div>
    </header>

    <main class="max-w-7xl mx-auto py-6 sm:px-6 lg:px-8">
        
        <div class="bg-white p-6 rounded-xl shadow-lg mb-6 mx-4 sm:mx-0">
            <p class="text-sm font-medium text-gray-500">Nome Utente:</p>
            <p id="profile-name" class="text-2xl font-bold text-gray-800 mb-4"></p>
            
            <div class="flex items-center justify-between p-4 bg-yellow-50 rounded-lg border border-yellow-200">
                <p class="font-semibold text-yellow-700">Karma Points Totali:</p>
                <span id="profile-cp-total" class="text-3xl font-extrabold text-yellow-600">0 CP</span>
            </div>
            
            <div class="mt-6 border-t pt-4">
                 <p class="text-sm font-medium text-gray-500">ID Utente (debug):</p>
                 <p id="profile-uid" class="text-xs text-gray-600 truncate"></p>
            </div>
        </div>

        <div class="space-y-4 mx-4 sm:mx-0">
            <button onclick="signOutUser()" class="w-full flex items-center justify-center bg-red-500 hover:bg-red-600 text-white font-medium py-3 px-4 rounded-lg shadow-md transition duration-200">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-log-out mr-2"><path d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4"/><polyline points="10 17 15 12 10 7"/><line x1="15" x2="3" y1="12" y2="12"/></svg>
                Logout
            </button>
        </div>
    </main>
</div>


<footer class="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 shadow-lg z-40">
    <nav class="max-w-lg mx-auto flex justify-around">
        
        <button class="tab-item text-blue-600 font-bold" id="nav-home" onclick="navigate('home-screen', this)">
            <div class="flex flex-col items-center p-2">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-home"><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>
                <span class="text-xs mt-1">Home</span>
            </div>
        </button>
        
        <button class="tab-item text-gray-500" id="nav-publish" onclick="openModal('publish-modal')">
            <div class="flex flex-col items-center p-2">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-plus-circle"><circle cx="12" cy="12" r="10"/><path d="M12 8v8"/><path d="M8 12h8"/></svg>
                <span class="text-xs mt-1">Pubblica</span>
            </div>
        </button>
        
        <button class="tab-item text-gray-500" id="nav-chat" onclick="navigate('chat-list-screen', this)">
            <div class="flex flex-col items-center p-2">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-message-square"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>
                <span class="text-xs mt-1">Chat</span>
            </div>
        </button>
        
        <button class="tab-item text-gray-500" id="nav-profile" onclick="navigate('profile-screen', this)">
            <div class="flex flex-col items-center p-2">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-user"><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
                <span class="text-xs mt-1">Profilo</span>
            </div>
        </button>
        
    </nav>
</footer>

</body>
</html>
