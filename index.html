<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EcoMunity - Scambio Etico e Comunitario</title>
<script type="module">
  // --- 1. IMPORTAZIONI COMPLETE FIREBASE ---
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
  // Importazioni per l'Autenticazione (Login Google)
  import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-auth.js";
  // Importazioni per il Database (Firestore - Interazioni/Pubblicazione)
  
  // AGGIUNTE: doc, deleteDoc, updateDoc, getDoc, setDoc, orderBy
import { getFirestore, collection, addDoc, query, where, onSnapshot, doc, deleteDoc, updateDoc, getDoc, setDoc, orderBy } 
from "https://www.gstatic.com/firebasejs/12.4.0/firebase-firestore.js";

  // Your web app's Firebase configuration (I tuoi dati restano invariati)
  const firebaseConfig = {
    apiKey: "AIzaSyCTwU75eJLGpuz5jw_gkhHdgYrHUkN__AY",
    authDomain: "ecomunity-app.firebaseapp.com",
    projectId: "ecomunity-app",
    storageBucket: "ecomunity-app.firebasestorage.app",
    messagingSenderId: "788175207861",
    appId: "1:788175207861:web:e3f159da01c096e0d3edfc"
  };

  // Inizializza Firebase
  const app = initializeApp(firebaseConfig);
  
  // --- 2. INIZIALIZZAZIONE SERVIZI FIREBASE ---
  const auth = getAuth(app); // Servizio di Autenticazione
  const db = getFirestore(app); // Servizio Database Firestore
  const googleProvider = new GoogleAuthProvider(); // Provider per Google Login
  
  // Variabile per tenere traccia del tipo di offerta (bene o servizio)
  let currentOfferType = 'bene';

  // --- FUNZIONI DI GESTIONE UI ---
  
  // Funzione per cambiare schermata
  function switchScreen(screenId) {
    document.querySelectorAll('.screen').forEach(screen => {
      screen.classList.remove('active');
    });
    const screenToShow = document.getElementById(screenId);
    if (screenToShow) {
        screenToShow.classList.add('active');
        // Nasconde sempre la schermata di login quando si entra nell'app
        document.getElementById('login-screen').style.display = 'none'; 
    }
  }

  // Funzione per gestire i click sulla Tab Bar
  window.navigate = function(screenId, element) {
    switchScreen(screenId);
    // Aggiorna lo stato "attivo" della tab bar
    document.querySelectorAll('.tab-item').forEach(item => {
        item.classList.remove('active');
    });
    element.classList.add('active');
  }

  // Funzione per il toggle del tipo di offerta nella schermata di Pubblicazione
  window.toggleOfferType = function(type) {
    currentOfferType = type;
    const btnBene = document.getElementById('type-bene');
    const btnServizio = document.getElementById('type-servizio');

    // Rimuove tutti gli stili attivi (verde, blu, ombra)
    btnBene.classList.remove('bg-[#22c55e]', 'bg-blue-600', 'text-white', 'shadow-lg');
    btnServizio.classList.remove('bg-[#22c55e]', 'bg-blue-600', 'text-white', 'shadow-lg');
    
    // Aggiunge stili non attivi
    btnBene.classList.add('text-gray-700', 'hover:bg-gray-200');
    btnServizio.classList.add('text-gray-700', 'hover:bg-gray-200');

    if (type === 'bene') {
        // Bene: Verde con ombra
        btnBene.classList.remove('text-gray-700', 'hover:bg-gray-200');
        btnBene.classList.add('bg-[#22c55e]', 'text-white', 'shadow-lg');
    } else {
        // Servizio: Blu con ombra
        btnServizio.classList.remove('text-gray-700', 'hover:bg-gray-200');
        btnServizio.classList.add('bg-blue-600', 'text-white', 'shadow-lg');
    }
  }

  // NUOVA FUNZIONE: per cambiare tra scheda Beni e Servizi sulla Home
  window.switchHomeTab = function(type, element) {
    // Nasconde tutti i contenuti della Home Tab
    document.querySelectorAll('.home-tab-content').forEach(content => {
      content.classList.add('hidden');
      content.classList.remove('active');
    });
    
    const btnBeni = document.getElementById('tab-btn-beni');
    const btnServizi = document.getElementById('tab-btn-servizi');

    // Rimuove tutti gli stili attivi (verde, blu, ombra)
    btnBeni.classList.remove('bg-[#22c55e]', 'bg-blue-600', 'text-white', 'shadow-lg', 'shadow-[#22c55e]/50', 'shadow-blue-600/50');
    btnServizi.classList.remove('bg-[#22c55e]', 'bg-blue-600', 'text-white', 'shadow-lg', 'shadow-[#22c55e]/50', 'shadow-blue-600/50');

    // Aggiunge stili non attivi
    btnBeni.classList.add('text-gray-700', 'hover:bg-gray-200');
    btnServizi.classList.add('text-gray-700', 'hover:bg-gray-200');

    // Mostra il contenuto corretto
    document.getElementById('home-' + type).classList.remove('hidden');
    document.getElementById('home-' + type).classList.add('active');

    // Applica lo stile attivo al bottone e rimuove lo stile non attivo
    element.classList.remove('text-gray-700', 'hover:bg-gray-200');
    
    if (type === 'bene') {
        // Bene: Verde con ombra (più visibile)
        element.classList.add('bg-[#22c55e]', 'text-white', 'shadow-lg', 'shadow-[#22c55e]/50');
    } else { // type === 'servizio'
        // Servizio: Blu con ombra (più visibile)
        element.classList.add('bg-blue-600', 'text-white', 'shadow-lg', 'shadow-blue-600/50');
    }
  }


  // --- 3. FUNZIONE DI AUTENTICAZIONE GOOGLE ---
  // Funzione chiamata dal pulsante di login (aggiunta a window per l'onclick)
  window.handleAuth = async function() {
    try {
        const result = await signInWithPopup(auth, googleProvider);
        // L'utente si è loggato con successo. onAuthStateChanged gestirà l'UI.
        console.log("Accesso Google completato per:", result.user.displayName);
    } catch (error) {
        // Gestione degli errori (es. l'utente ha chiuso il popup)
        console.error("Errore di Autenticazione:", error.code, error.message);
        if (error.code !== 'auth/popup-closed-by-user') {
            alert("Errore di accesso. Riprova: " + error.message);
        }
    }
  };

  // Funzione di Logout (da collegare a un pulsante nella schermata Profilo)
  window.handleLogout = async function() {
      await signOut(auth);
      console.log("Utente disconnesso.");
      // onAuthStateChanged gestirà il reindirizzamento alla schermata di Login
  }


  // --- 4. GESTIONE STATO UTENTE (ON LOAD) ---
  // Controlla lo stato di autenticazione all'avvio dell'app
  onAuthStateChanged(auth, (user) => {
    // 1. Nasconde la schermata di caricamento
    document.getElementById('loading-screen').style.display = 'none';
    document.getElementById('app-container').classList.remove('hidden');
    
    if (user) {
        // Utente loggato (Registrato o Ri-loggato)
        console.log("Utente attivo:", user.uid, user.displayName);

        // **MODIFICHE PER GARANTIRE LA VISIBILITÀ SU TUTTI I BROWSER**
        document.getElementById('app-header').style.display = 'block'; 
        document.getElementById('tab-bar').style.display = 'flex'; 
        
        // Aggiorna l'UI del profilo se necessario (es. nome utente)
        document.getElementById('profile-name').textContent = user.displayName || "Utente EcoMunity";
        
        // Passa alla schermata Home e attiva l'icona
        switchScreen('home-screen');
        document.getElementById('nav-home').classList.add('active');

        // Carica le offerte dal database
        loadOffers(); 
        loadChatList(); // Serve per inizializzare il listener dei messaggi
    } else {
        // Utente NON loggato
        console.log("Nessun utente loggato. Mostra schermata di Login.");
        // Mostra la schermata di Login (deve essere in display:flex per il centraggio)
        document.getElementById('login-screen').style.display = 'flex';
        // Nasconde l'header e la tab bar quando non loggato
        document.getElementById('app-header').style.display = 'none';
        document.getElementById('tab-bar').style.display = 'none';
    }
  });
  
// Variabile per tenere traccia della chat correntemente aperta
let currentChatId = null;

// Funzione per aprire una chat specifica
window.openChat = function(chatId, offerTitle) {
    currentChatId = chatId;
    document.getElementById('current-chat-id').value = chatId;
    document.getElementById('current-chat-title').textContent = offerTitle;
    
    // Passa alla schermata di chat
    document.getElementById('chat-screen').style.display = 'flex';
    
    // Rimuovi l'header e la tab bar per la chat
    document.getElementById('app-header').style.display = 'none';
    document.getElementById('tab-bar').style.display = 'none';

    // Carica i messaggi
    loadChatMessages(chatId);
}

// Funzione per inviare un messaggio
window.sendMessage = async function(event) {
    event.preventDefault();
    const messageInput = document.getElementById('message-input');
    const messageText = messageInput.value.trim();
    const chatId = document.getElementById('current-chat-id').value;
    const currentUser = auth.currentUser;

    if (!messageText || !chatId || !currentUser) {
        return;
    }

    try {
        // 1. Aggiungi il messaggio alla sottocollezione 'messages'
        await addDoc(collection(db, "chats", chatId, "messages"), {
            senderId: currentUser.uid,
            senderName: currentUser.displayName,
            text: messageText,
            timestamp: new Date()
        });

        // 2. Aggiorna l'ultimo messaggio nel documento principale della chat (ottimizzazione)
        const chatRef = doc(db, "chats", chatId);
        await updateDoc(chatRef, {
            lastMessage: messageText.substring(0, 50) + (messageText.length > 50 ? '...' : ''),
            lastMessageTimestamp: new Date()
        });

        // Resetta il campo di input
        messageInput.value = '';
        
    } catch (e) {
        console.error("Errore nell'invio del messaggio: ", e);
        alert("Impossibile inviare il messaggio.");
    }
}

// Funzione per caricare e visualizzare i messaggi in tempo reale
function loadChatMessages(chatId) {
    if (!chatId) return;

    const currentUser = auth.currentUser;
    const messagesContainer = document.getElementById('messages-container');
    
    // Inizia l'ascolto in tempo reale sulla sottocollezione 'messages', ordinando per timestamp
    const q = query(collection(db, "chats", chatId, "messages"), orderBy("timestamp", "asc"));

    onSnapshot(q, (querySnapshot) => {
        let messagesHtml = '';
        
        querySnapshot.forEach((doc) => {
            const msg = doc.data();
            const isMe = msg.senderId === currentUser.uid;
            
            // Stile del messaggio a seconda del mittente
            const messageClass = isMe 
                ? 'self-end bg-[#dcf8c6] text-gray-900 rounded-bl-xl rounded-tl-xl rounded-tr-xl' 
                : 'self-start bg-white text-gray-800 rounded-br-xl rounded-tr-xl rounded-tl-xl border border-gray-100';
            
            const timeString = msg.timestamp && msg.timestamp.toDate ? msg.timestamp.toDate().toLocaleTimeString('it-IT', { hour: '2-digit', minute: '2-digit' }) : 'Ora Sconosciuta';

            messagesHtml += `
                <div class="max-w-[75%] p-3 shadow-sm ${messageClass}">
                    <p class="text-sm">${msg.text}</p>
                    <span class="text-xs text-right block ${isMe ? 'text-gray-600' : 'text-gray-500'} mt-1">${timeString}</span>
                </div>
            `;
        });

        messagesContainer.innerHTML = messagesHtml;
        // Scorrimento automatico in basso (necessario per le chat)
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
    });
}

// Funzione di navigazione per tornare dalla chat
window.navigateFromChat = function(screenId, element) {
    document.getElementById('chat-screen').style.display = 'none';
    
    // Riporta l'header e la tab bar
    document.getElementById('app-header').style.display = 'block'; 
    document.getElementById('tab-bar').style.display = 'flex'; 

    // Esegui la navigazione standard
    switchScreen(screenId);
    document.querySelectorAll('.tab-item').forEach(item => {
        item.classList.remove('active');
    });
    element.classList.add('active');
}

  // --- 5. INTERAZIONE DATABASE (ESEMPIO DI PUBBLICAZIONE) ---
  // Funzione per salvare una nuova offerta su Firestore
  window.publishOffer = async function(event) {
    event.preventDefault(); // Impedisce il ricaricamento della pagina
    
    // Recupera i dati del form
    const title = document.getElementById('title').value;
    const description = document.getElementById('description').value;
    // AGGIUNTA: Recupera il valore CP e assicurati che sia un numero intero
    const cpValue = parseInt(document.getElementById('cp-value').value, 10);
    
    // Controllo base sul valore CP
    if (isNaN(cpValue) || cpValue <= 0) {
        alert("Inserisci un valore Karma (CP) valido e positivo.");
        return;
    }
    
    // Ottieni l'utente corrente per associare l'offerta
    const user = auth.currentUser;
    if (!user) {
        alert("Devi essere loggato per pubblicare un'offerta.");
        return;
    }

    try {
        const docRef = await addDoc(collection(db, "offerte"), {
            title: title,
            description: description,
            type: currentOfferType, // 'bene' o 'servizio'
            cpValue: cpValue, // AGGIUNTA: Salva il valore CP
            ownerId: user.uid,
            ownerName: user.displayName,
            timestamp: new Date(),
            status: 'available'
        });
        
        console.log("Documento scritto con ID: ", docRef.id);
        alert("Offerta pubblicata con successo!");
        // Reset del form e navigazione alla home
        document.getElementById('publish-form').reset();
        window.navigate('home-screen', document.getElementById('nav-home'));
    } catch (e) {
        console.error("Errore durante l'aggiunta del documento: ", e);
        alert("Errore durante la pubblicazione. Controlla la console.");
    }
  }
  
  // NUOVA FUNZIONE: ELIMINA OFFERTA
  window.deleteOffer = async function(docId) {
    if (confirm("Sei sicuro di voler eliminare questa offerta? L'azione è irreversibile.")) {
        try {
            // Trova il riferimento al documento e lo elimina
            await deleteDoc(doc(db, "offerte", docId));
            console.log("Documento eliminato con ID:", docId);
            alert("Offerta eliminata con successo!");
            // L'aggiornamento UI è automatico grazie a onSnapshot in loadOffers
        } catch (e) {
            console.error("Errore durante l'eliminazione del documento: ", e);
            alert("Errore durante l'eliminazione. Controlla le regole di sicurezza (write).");
        }
    }
  }

// ************************************************************
// ** NUOVE FUNZIONI DI GESTIONE CHAT, STATO E ASSEGNAZIONE CP **
// ************************************************************
// NUOVA FUNZIONE: Richiede il feedback, gestisce l'assegnazione di CP e imposta lo stato a 'completed'
window.requestFeedback = async function(docId, cpValue) {
    const user = auth.currentUser;
    if (!user) {
        alert("Errore di autenticazione.");
        return;
    }
    const offerRef = doc(db, "offerte", docId);
    const offerSnap = await getDoc(offerRef); // Ottiene lo stato attuale
    if (!offerSnap.exists() || offerSnap.data().status !== 'reserved' || offerSnap.data().ownerId !== user.uid) {
        alert("Impossibile completare. L'offerta non è riservata o non sei il proprietario.");
        return;
    }

    // Semplice richiesta di feedback tramite prompt per simulare le 3 opzioni (SIMULAZIONE CP/Karma)
    const feedback = prompt(
        "L'oggetto è stato ritirato con successo? Scegli un'opzione:\n" +
        "1: Andato a Buon Fine (Assegna 100% CP)\n" +
        "2: Meritevole (Extra CP, +120%)\n" +
        "3: Qualcosa Non ha Funzionato (0 CP, Bassa affidabilità)"
    );

    let finalCP = 0;
    let feedbackType = '';

    switch (feedback) {
        case '1':
            finalCP = cpValue; // 100% del valore (Es. 50 CP)
            feedbackType = 'success';
            break;
        case '2':
            finalCP = Math.round(cpValue * 1.2); // 120% del valore (Es. 60 CP)
            feedbackType = 'merit';
            break;
        case '3':
            finalCP = 0; // Nessun CP
            feedbackType = 'fail';
            break;
        default:
            alert("Selezione non valida. Annullato.");
            return;
    }
    
    if (feedbackType === 'fail' && !confirm("Sei sicuro di voler dare un feedback negativo? L'acquirente non riceverà CP.")) {
        return;
    }

    try {
        // 1. Aggiornamento Stato Offerta a 'completed'
        await updateDoc(offerRef, {
            status: 'completed',
            feedback: feedbackType,
            cp_awarded: finalCP,
            completionDate: new Date()
        });

        // 2. Notifica e ricarica
        alert(`Scambio completato! L'acquirente riceverà ${finalCP} CP.`);
        loadOffers();
    } catch (e) {
        console.error("Errore durante il completamento dello scambio: ", e);
        alert("Errore nel completare lo scambio. Controlla la console.");
    }
}


// NUOVA FUNZIONE: Avvia la chat, imposta l'offerta a 'reserved' e reindirizza
// Versione corretta che controlla l'esistenza della chat e aggiorna lo stato
window.reserveAndChat = async function(offerId, offerOwnerId, offerTitle) {
    const currentUser = auth.currentUser;
    if (!currentUser || currentUser.uid === offerOwnerId) {
        alert("Non puoi avviare una chat per la tua offerta o non sei loggato.");
        return;
    }

    const offerRef = doc(db, "offerte", offerId);
    const offerSnap = await getDoc(offerRef);
    const offerData = offerSnap.data();

    // 1. Blocco se l'offerta non è 'available'
    if (offerData.status !== 'available') {
        alert("Questa offerta non è più disponibile.");
        loadOffers();
        return;
    }

    // 2. Tenta di trovare una chat esistente (tra owner e buyer per questa offerta)
    const chatQuery = query(
        collection(db, "chats"),
        where("offerId", "==", offerId),
        where("users", "array-contains", currentUser.uid) // Controlla se l'utente è già nella chat
    );
    const chatSnapshot = await getDocs(chatQuery);
    
    let chatId;

    if (!chatSnapshot.empty) {
        // Chat esistente: recupera l'ID
        chatId = chatSnapshot.docs[0].id;
        console.log("Chat esistente trovata:", chatId);
    } else {
        // Chat NON esistente: creane una nuova
        try {
            const chatDocRef = await addDoc(collection(db, "chats"), {
                offerId: offerId,
                offerTitle: offerTitle,
                ownerId: offerOwnerId,
                buyerId: currentUser.uid,
                users: [offerOwnerId, currentUser.uid],
                createdAt: new Date(),
                lastMessage: 'Chat avviata.',
                lastMessageTimestamp: new Date()
            });
            chatId = chatDocRef.id;
            console.log("Nuova chat creata con ID:", chatId);
        } catch (e) {
            console.error("Errore durante la creazione della chat:", e);
            alert("Impossibile avviare la chat.");
            return;
        }
    }

    // 3. Aggiorna lo stato dell'offerta a 'reserved' in Firestore
    try {
        await updateDoc(offerRef, {
            status: 'reserved',
            reservedBy: currentUser.uid, // Aggiungi l'ID di chi l'ha riservata
            reservedAt: new Date()
        });
        console.log(`Stato offerta ${offerId} aggiornato a 'reserved'`);
    } catch (e) {
        console.error("Errore nell'aggiornamento dello stato offerta:", e);
        alert("Impossibile riservare l'offerta. Controlla la console.");
        return;
    }

    // 4. Apri la schermata di chat
    window.openChat(chatId, offerTitle);
}

// NUOVA FUNZIONE: Resetta lo stato dell'offerta (dall'acquirente)
window.cancelReservation = async function(docId) {
    if (!confirm("Sei sicuro di voler annullare la prenotazione? L'offerta tornerà disponibile a tutti.")) {
        return;
    }

    const offerRef = doc(db, "offerte", docId);
    try {
        await updateDoc(offerRef, {
            status: 'available',
            reservedBy: null,
            reservedAt: null
        });
        alert("Prenotazione annullata. L'offerta è di nuovo disponibile.");
        loadOffers(); // Ricarica per aggiornare l'UI
    } catch (e) {
        console.error("Errore durante l'annullamento della prenotazione:", e);
        alert("Impossibile annullare. Riprova.");
    }
}


// --- 6. GESTIONE DATI (OFFERTE e CHAT) ---

// Funzione per caricare la lista delle chat
function loadChatList() {
    const currentUser = auth.currentUser;
    if (!currentUser) return;
    
    const chatListContainer = document.getElementById('chat-list');

    // Query per le chat in cui l'utente è un partecipante
    const q = query(
        collection(db, "chats"), 
        where("users", "array-contains", currentUser.uid),
        orderBy("lastMessageTimestamp", "desc") // Ordina per messaggio più recente
    );

    onSnapshot(q, (snapshot) => {
        let chatHtml = '';
        if (snapshot.empty) {
            chatListContainer.innerHTML = '<p class="text-center text-gray-500 mt-8">Nessuna chat attiva.</p>';
            return;
        }

        snapshot.forEach((doc) => {
            const chat = doc.data();
            const isOwner = chat.ownerId === currentUser.uid;
            // Identifica l'altro utente
            const otherUserName = isOwner ? chat.buyerId : chat.ownerId; // Nota: Qui andrebbe recuperato il nome utente! Per ora usiamo solo offerTitle.
            const statusText = isOwner ? 'Offerta tua' : 'Tua prenotazione';

            // Determina il nome da mostrare nella lista chat
            // Per semplicità, mostriamo il titolo dell'offerta
            const chatDisplayName = chat.offerTitle || 'Chat senza titolo';

            chatHtml += `
                <div onclick="openChat('${doc.id}', '${chat.offerTitle.replace(/'/g, "\\'")}')" 
                     class="flex items-center p-4 border-b border-gray-200 hover:bg-gray-50 cursor-pointer">
                    <div class="flex-shrink-0 mr-4">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-message-square text-gray-500"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>
                    </div>
                    <div class="flex-1 min-w-0">
                        <p class="text-sm font-semibold text-gray-800 truncate">${chatDisplayName}</p>
                        <p class="text-xs text-gray-500 truncate mt-0.5">${chat.lastMessage}</p>
                    </div>
                    <div class="ml-4 flex flex-col items-end">
                        <span class="text-xs font-medium ${isOwner ? 'text-green-600' : 'text-blue-600'}">${statusText}</span>
                        <span class="text-xs text-gray-400 mt-1">${chat.lastMessageTimestamp ? chat.lastMessageTimestamp.toDate().toLocaleDateString('it-IT') : 'N/D'}</span>
                    </div>
                </div>
            `;
        });

        chatListContainer.innerHTML = chatHtml;
    });
}


// Funzione per caricare i dati del profilo
function loadProfileData(userId) {
    const profileDataContainer = document.getElementById('profile-data');
    // Ipotizziamo una collezione 'users' per i dati di Karma
    const userRef = doc(db, "users", userId); 

    // Esempio: assicurati che il documento utente esista
    setDoc(userRef, { 
        displayName: auth.currentUser.displayName, 
        email: auth.currentUser.email,
        karmaPoints: 100 // Valore iniziale
    }, { merge: true }); // Merge: true non sovrascrive se esiste, aggiunge se manca

    onSnapshot(userRef, (docSnap) => {
        if (docSnap.exists()) {
            const userData = docSnap.data();
            const karma = userData.karmaPoints || 0;
            const completedSwaps = userData.completedSwaps || 0;
            
            profileDataContainer.innerHTML = `
                <p class="text-3xl font-bold text-gray-900">${karma}</p>
                <p class="text-sm text-gray-500 mb-4">Punti Karma (CP)</p>
                <div class="flex justify-around w-full mt-4">
                    <div class="text-center">
                        <p class="text-xl font-semibold text-green-600">${completedSwaps}</p>
                        <p class="text-xs text-gray-500">Scambi Completati</p>
                    </div>
                    <div class="text-center">
                        <p class="text-xl font-semibold text-yellow-600">${karma}</p>
                        <p class="text-xs text-gray-500">Affidabilità</p>
                    </div>
                </div>
            `;
            // Aggiorna l'header con il nome utente
            document.getElementById('profile-name-header').textContent = auth.currentUser.displayName;

            // Ricarica anche le offerte per aggiornare l'UI dei bottoni
            loadOffers();

        } else {
            console.log("Documento utente non trovato, creato uno di base.");
        }
    });

}

// Funzione principale per caricare e visualizzare le offerte
function loadOffers() {
      const currentUser = auth.currentUser;
      if (!currentUser) return;

      const q = query(collection(db, "offerte"), orderBy("timestamp", "desc")); // Ordina per data (più recente)

      onSnapshot(q, (querySnapshot) => {
          let beniHtml = '';
          let serviziHtml = '';

          querySnapshot.forEach((doc) => {
              const offer = doc.data();
              const docId = doc.id;
              const cpValue = offer.cpValue || 10;
              const isOwner = offer.ownerId === currentUser.uid;
              const isReserved = offer.status === 'reserved';
              const isCompleted = offer.status === 'completed';
              const isReservedByMe = isReserved && offer.reservedBy === currentUser.uid;

              let actionButton = '';
              let ownerButtons = ''; // Bottoni aggiuntivi per il proprietario (es. Elimina)
              let statusTag = '';

              // --- Logica dei Bottoni ---
              if (isCompleted) {
                  statusTag = `<span class="text-xs font-semibold px-2 py-0.5 rounded-full bg-gray-200 text-gray-600">Completato</span>`;
                  if (isOwner) {
                      ownerButtons = `<button disabled class="mt-2 w-full px-4 py-2 text-sm font-medium rounded-lg text-gray-500 bg-gray-100 cursor-not-allowed">Scambio Completato</button>`;
                  }
              } else if (isReserved) {
                  const statusColor = isReservedByMe ? 'bg-blue-200 text-blue-800' : 'bg-yellow-200 text-yellow-800';
                  statusTag = `<span class="text-xs font-semibold px-2 py-0.5 rounded-full ${statusColor}">${isReservedByMe ? 'Prenotato da te' : 'Riservato'}</span>`;

                  if (isReservedByMe) {
                      // Se l'ho riservata io, posso annullare
                      actionButton = `<button onclick="cancelReservation('${docId}')" class="mt-2 w-full bg-red-500 hover:bg-red-600 text-white px-4 py-2 text-sm font-medium rounded-lg shadow-md">Annulla Prenotazione</button>`;
                  } else if (isOwner) {
                      // Se sono il proprietario e l'offerta è riservata
                      ownerButtons = `
                        <p class="text-sm font-semibold text-yellow-600 mt-2">Riservato a ${offer.reservedBy}</p>
                        <button onclick="requestFeedback('${docId}', ${cpValue})" class="mt-2 w-full bg-green-500 hover:bg-green-600 text-white px-4 py-2 text-sm font-medium rounded-lg shadow-md">Completa Scambio</button>
                      `;
                  } else {
                      // Se sono un terzo, non posso interagire
                      actionButton = `<button disabled class="mt-2 w-full px-4 py-2 text-sm font-medium rounded-lg text-gray-500 bg-gray-100 cursor-not-allowed">Non Disponibile</button>`;
                  }
              } else { // status === 'available'
                  statusTag = `<span class="text-xs font-semibold px-2 py-0.5 rounded-full bg-green-200 text-green-800">Disponibile</span>`;
                  if (isOwner) {
                      // Posso solo eliminare la mia offerta disponibile
                      ownerButtons = `<button onclick="deleteOffer('${docId}')" class="mt-2 w-full bg-red-500 hover:bg-red-600 text-white px-4 py-2 text-sm font-medium rounded-lg shadow-md">Elimina Offerta</button>`;
                  } else {
                      // Posso riservare e chattare
                      actionButton = `<button onclick="reserveAndChat('${docId}', '${offer.ownerId}', '${offer.title.replace(/'/g, "\\'")}')" class="mt-2 w-full bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 text-sm font-medium rounded-lg shadow-md">Riserva e Chat</button>`;
                  }
              }
              
              // --- Creazione HTML Card ---
              const typeColor = offer.type === 'bene' ? 'bg-[#22c55e]' : 'bg-blue-600'; // Verde per bene, Blu per servizio
              const iconSvg = offer.type === 'bene' 
                  ? `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-box"><path d="M21 8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16Z"/><path d="m3.3 7 8.7 5 8.7-5"/><path d="M12 22V12"/></svg>`
                  : `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-wrench"><path d="M.4 17.5a2.17 2.17 0 0 1 3.2-3.2l2.7 2.7l.9-.9l-2.7-2.7a2.17 2.17 0 0 1 3.2-3.2l.9 .9l.9-.9l-2.7-2.7a2.17 2.17 0 0 1 3.2-3.2l.9 .9l.9-.9l-2.7-2.7a2.17 2.17 0 0 1 3.2-3.2l2.7 2.7l.9-.9l-2.7-2.7a2.17 2.17 0 0 1 3.2-3.2L12 12l9.1 9.1"/></svg>`;


              const offerHtml = `
                <div class="bg-white p-4 rounded-xl shadow-lg border border-gray-100 flex flex-col justify-between">
                    <div class="flex items-start mb-3">
                        <div class="p-3 rounded-full ${typeColor} text-white mr-3">${iconSvg}</div>
                        <div class="flex-1">
                            <h3 class="text-lg font-semibold text-gray-800">${offer.title}</h3>
                            ${statusTag}
                        </div>
                    </div>
                    <div>
                        <p class="text-sm text-gray-600">${offer.description}</p>
                        <p class="text-xs text-gray-400 mt-1">Offerto da: ${offer.ownerName}</p>
                        <p class="text-sm font-bold text-yellow-600 mt-2">Valore: ${cpValue} CP</p>
                        ${ownerButtons}
                    </div>
                    ${actionButton}
                </div>
              `;

              if (offer.type === 'bene') {
                  beniHtml += offerHtml;
              } else if (offer.type === 'servizio') {
                  serviziHtml += offerHtml;
              }
          });

          // Aggiorna l'HTML della Home Screen
          document.getElementById('item-list-bene').innerHTML = beniHtml;
          document.getElementById('item-list-servizio').innerHTML = serviziHtml;
          document.getElementById('empty-bene').style.display = beniHtml ? 'none' : 'block';
          document.getElementById('empty-servizio').style.display = serviziHtml ? 'none' : 'block';
      });
  }

  // --- 7. INIZIALIZZAZIONE ---
  // Listener di autenticazione: gestisce login/logout e carica i dati iniziali
  onAuthStateChanged(auth, (user) => {
      // 1. Nasconde la schermata di caricamento
      document.getElementById('loading-screen').style.display = 'none';
      document.getElementById('app-container').classList.remove('hidden');

      if (user) {
          // Utente loggato
          window.navigate('home-screen', document.getElementById('nav-home'));
          
          // **MODIFICHE PER GARANTIRE LA VISIBILITÀ SU TUTTI I BROWSER**
          document.getElementById('app-header').style.display = 'block'; 
          document.getElementById('tab-bar').style.display = 'flex'; 

          loadOffers(); 
          loadChatList(); 
          loadProfileData(user.uid); 
      } else {
          // Utente NON loggato
          document.getElementById('login-screen').style.display = 'flex';
          document.getElementById('app-header').style.display = 'none';
          document.getElementById('tab-bar').style.display = 'none';
      }
  });
</script>


<link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
<style>
  /* Nasconde tutte le schermate tranne l'attiva, impostazione di default per il routing a singola pagina */
  .screen:not(.active) {
    display: none;
  }
  
  /* Stile di base per le schermate per usare il flexbox */
  .screen {
    display: flex;
    flex-direction: column;
    height: calc(100vh - 56px - 64px); /* Altezza meno Header (56px) e Tab Bar (64px) */
    overflow-y: auto;
    padding-bottom: 20px; /* Spazio extra in basso */
  }

  /* Stile specifico per la schermata Home con padding sopra e sotto */
  #home-screen {
    height: calc(100vh - 56px - 64px);
  }

  /* Stile per la schermata di chat (a schermo intero temporaneamente) */
  #chat-screen {
    display: none; /* Inizialmente nascosto */
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: white;
    z-index: 50;
    flex-direction: column;
  }
  
  /* Stile per la schermata di login (centrata) */
  #login-screen {
      display: none; /* Inizialmente nascosto */
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: #f7f7f7;
      z-index: 100; /* Assicurati che sia sopra tutto */
      justify-content: center;
      align-items: center;
  }

  /* Stile per lo spinner di caricamento */
  #loading-screen {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: white;
    z-index: 200;
    display: flex;
    justify-content: center;
    align-items: center;
    flex-direction: column;
  }

  /* Rende la Tab Bar fissa in basso */
  #tab-bar {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      border-top: 1px solid #e5e7eb;
      z-index: 10;
  }
  
  /* Rende l'Header fisso in alto */
  #app-header {
      position: sticky;
      top: 0;
      z-index: 10;
  }
</style>
</head>

<body class="bg-gray-50 font-sans">

    <div id="loading-screen">
        <div class="animate-spin rounded-full h-16 w-16 border-t-2 border-b-2 border-green-500"></div>
        <p class="mt-4 text-gray-700">Caricamento EcoMunity...</p>
    </div>

    <div id="app-container" class="hidden max-w-md mx-auto bg-white min-h-screen shadow-lg">

        <header id="app-header" class="bg-white p-4 border-b border-gray-200">
            <h1 class="text-xl font-bold text-green-600">EcoMunity</h1>
        </header>

        <main class="h-full overflow-y-auto pb-16">

            <section id="home-screen" class="screen active">
                <div class="p-4 border-b border-gray-200">
                    <h2 class="text-xl font-semibold text-gray-800">Annunci</h2>
                    <div class="flex mt-4 bg-gray-100 rounded-lg p-1 space-x-1 shadow-md">
                        <button id="tab-btn-beni" 
                                onclick="switchHomeTab('bene', this)" 
                                class="flex-1 py-3 px-4 text-sm font-medium rounded-md 
                                       bg-[#22c55e] text-white shadow-lg shadow-[#22c55e]/50"> Beni Materiali 
                        </button>
                        <button id="tab-btn-servizi" 
                                onclick="switchHomeTab('servizio', this)" 
                                class="flex-1 py-3 px-4 text-sm font-medium text-gray-700 rounded-md 
                                       hover:bg-gray-200"> Servizi/Aiuto
                        </button>
                    </div>
                </div>

                <div id="home-bene" class="home-tab-content p-4 grid grid-cols-1 gap-4 active">
                    <p id="empty-bene" class="text-center text-gray-500 mt-8 hidden">Nessun bene materiale disponibile al momento.</p>
                    <div id="item-list-bene" class="grid grid-cols-1 gap-4">
                        </div>
                </div>

                <div id="home-servizio" class="home-tab-content p-4 grid grid-cols-1 gap-4 hidden">
                    <p id="empty-servizio" class="text-center text-gray-500 mt-8 hidden">Nessun servizio o aiuto disponibile al momento.</p>
                    <div id="item-list-servizio" class="grid grid-cols-1 gap-4">
                        </div>
                </div>

            </section>


            <section id="publish-screen" class="screen">
                <div class="p-4 flex-1 overflow-y-auto">
                    <h2 class="text-xl font-semibold text-gray-800 mb-4">Pubblica una Nuova Offerta</h2>
                    
                    <form id="publish-form" onsubmit="publishOffer(event)">
                        
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Tipo di Offerta</label>
                            <div class="flex bg-gray-100 rounded-lg p-1 space-x-1 shadow-md"> <button type="button" 
                                        id="type-bene" 
                                        onclick="toggleOfferType('bene')"
                                        class="flex-1 py-3 px-4 text-sm font-medium rounded-md bg-[#22c55e] text-white shadow-lg"> Bene Materiale
                                </button>
                                <button type="button" 
                                        id="type-servizio" 
                                        onclick="toggleOfferType('servizio')"
                                        class="flex-1 py-3 px-4 text-sm font-medium text-gray-700 rounded-md hover:bg-gray-200"> Servizio / Aiuto
                                </button>
                            </div>
                        </div>


                        <div class="mb-4">
                            <label for="title" class="block text-sm font-medium text-gray-700">Titolo</label>
                            <input type="text" id="title" required
                                   class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500 sm:text-sm"
                                   placeholder="Es. Bicicletta usata, Lezione di chitarra">
                        </div>
        
                        <div class="mb-4">
                            <label for="description" class="block text-sm font-medium text-gray-700">Descrizione</label>
                            <textarea id="description" rows="3" required
                                      class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500 sm:text-sm"
                                      placeholder="Descrivi brevemente cosa offri e perché."></textarea>
                        </div>
                        
                        <div class="mb-6">
                            <label for="cp-value" class="block text-sm font-medium text-gray-700">Valore Karma (CP)</label>
                            <input type="number" id="cp-value" required min="1" value="10"
                                   class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-yellow-500 focus:border-yellow-500 sm:text-sm"
                                   placeholder="Valore atteso dello scambio in Punti Karma">
                            <p class="mt-2 text-xs text-gray-500">Un valore giusto aiuta a bilanciare la comunità.</p>
                        </div>
        
                        <button type="submit"
                                class="w-full flex justify-center py-3 px-4 border border-transparent rounded-md shadow-lg text-sm font-medium text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500">
                            Pubblica Offerta
                        </button>
                    </form>
                </div>
            </section>

            <section id="chat-list-screen" class="screen">
                <div class="p-4 border-b border-gray-200">
                    <h2 class="text-xl font-semibold text-gray-800">Le Tue Chat</h2>
                </div>
                <div id="chat-list" class="flex-1 overflow-y-auto">
                    </div>
            </section>
            
            <section id="profile-screen" class="screen items-center">
                <div class="w-full text-center p-4 bg-white border-b border-gray-200">
                    <h2 id="profile-name-header" class="text-2xl font-bold text-gray-800 mb-1">Nome Utente</h2>
                    <p class="text-sm text-gray-500">Membro EcoMunity</p>
                </div>
                
                <div id="profile-data" class="w-full text-center p-6 mt-4 bg-white rounded-lg shadow-md border border-gray-100">
                    </div>
                
                <div class="mt-8 w-full p-4">
                    <h3 class="text-lg font-semibold text-gray-700 mb-3">Opzioni</h3>
                    
                    <button onclick="handleLogout()"
                            class="w-full flex justify-center py-3 px-4 border border-transparent rounded-md shadow-lg text-sm font-medium text-white bg-red-600 hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500">
                        Logout
                    </button>
                </div>
            </section>

        </main>
        
        <div id="chat-screen">
            <header class="bg-white p-4 border-b border-gray-200 flex items-center shadow-sm sticky top-0">
                <button onclick="navigateFromChat('chat-list-screen', document.getElementById('nav-chat'))" class="mr-3 p-1 rounded-full hover:bg-gray-100">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-arrow-left"><path d="m12 19-7-7 7-7"/><path d="M19 12H5"/></svg>
                </button>
                <h2 id="current-chat-title" class="text-lg font-semibold text-gray-800 truncate flex-1">Chat Titolo</h2>
            </header>

            <div id="messages-container" class="flex-1 overflow-y-auto p-4 flex flex-col space-y-3">
                </div>

            <form onsubmit="sendMessage(event)" class="p-4 bg-gray-50 border-t border-gray-200 sticky bottom-0">
                <input type="hidden" id="current-chat-id">
                <div class="flex">
                    <input type="text" id="message-input" placeholder="Scrivi un messaggio..." required
                           class="flex-1 px-4 py-2 border border-gray-300 rounded-l-full shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500">
                    <button type="submit"
                            class="px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded-r-full shadow-md flex items-center justify-center">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-send-horizonal"><path d="m3 3 3 9-3 9 19-9Z"/><path d="M6 12h16"/></svg>
                    </button>
                </div>
            </form>
        </div>

        <nav id="tab-bar" class="bg-white flex justify-around shadow-lg">
            
            <button class="tab-item active" id="nav-home" onclick="navigate('home-screen', this)">
                <div class="flex flex-col items-center p-2">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-home"><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>
                    <span class="text-xs mt-1">Home</span>
                </div>
            </button>
            
            <button class="tab-item" id="nav-publish" onclick="navigate('publish-screen', this)">
                <div class="flex flex-col items-center p-2">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-plus-circle"><circle cx="12" cy="12" r="10"/><path d="M12 8v8"/><path d="M8 12h8"/></svg>
                    <span class="text-xs mt-1">Pubblica</span>
                </div>
            </button>
            
            <button class="tab-item" id="nav-chat" onclick="navigate('chat-list-screen', this)">
                <div class="flex flex-col items-center p-2">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-message-square"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>
                    <span class="text-xs mt-1">Chat</span>
                </div>
            </button>
            
            <button class="tab-item" id="nav-profile" onclick="navigate('profile-screen', this)">
                <div class="flex flex-col items-center p-2">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-user"><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
                    <span class="text-xs mt-1">Profilo</span>
                </div>
            </button>
        </nav>
        
        <div id="login-screen">
            <div class="bg-white p-8 rounded-xl shadow-2xl text-center max-w-xs w-full">
                <h2 class="text-3xl font-bold text-green-600 mb-2">EcoMunity</h2>
                <p class="text-gray-600 mb-8">Scambio Etico e Comunitario</p>
                
                <button onclick="handleAuth()"
                        class="w-full flex items-center justify-center py-3 px-4 border border-transparent rounded-md shadow-lg text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                    <svg class="w-5 h-5 mr-2" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12.24 10.24v3.54h6.08c-.2 1.25-.8 2.22-1.74 2.87-1.12.8-2.67 1.25-4.34 1.25-3.32 0-6.02-2.7-6.02-6.02s2.7-6.02 6.02-6.02c1.76 0 3.3.62 4.54 1.8l2.67-2.67c-1.8-1.7-4.1-2.76-6.42-2.76-4.97 0-9 4.03-9 9s4.03 9 9 9c4.87 0 8.78-3.4 8.78-8.78 0-.9-.08-1.7-.24-2.48h-8.54z" fill-rule="evenodd" clip-rule="evenodd"/></svg>
                    Accedi con Google
                </button>
                <p class="text-xs text-gray-400 mt-4">La tua privacy è importante per noi.</p>
            </div>
        </div>

    </div>
</body>
</html>
